#! /bin/sh

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>

case "$1" in
    configure)
        # add asterisk user
        if ! getent passwd asterisk > /dev/null ; then
                echo 'Adding system user for Asterisk' 1>&2
                adduser --system --group --quiet \
                        --home /var/lib/asterisk \
                        --no-create-home --disabled-login \
                        --gecos "Asterisk PBX daemon" \
                        asterisk
        fi

        # add asterisk to required groups
        for group in dialout audio; do
                if groups asterisk | grep -w -q -v $group; then
                        adduser asterisk $group
                fi
        done

        # chown asterisk on all $dirs and their subdirectories
        # do not harm the files, they should be empty on new installations
        # and we don't want to mess-up anything on old installations
        find /var/log/asterisk \
             /var/lib/asterisk \
             -type d | while read dir; do
                if ! dpkg-statoverride --list "$dir" > /dev/null ; then
                        chown asterisk: "$dir"
                fi
        done 

        # this is not needed for new installations but is not such a bad idea
        # removing this will _break_ upgrades from versions < 1:1.4.10.1~dfsg-1
        #
        # we are doing the same for subdirectories, since we are not shipping
        # any and it's supposed to be user-modifiable
        if ! dpkg-statoverride --list "/etc/asterisk" > /dev/null ; then
                chown asterisk: /etc/asterisk
        fi

        # spool holds some sensitive information (e.g. monitor, voicemail etc.)
        find /var/spool/asterisk -type d | while read dir; do
                if ! dpkg-statoverride --list "$dir" > /dev/null ; then
                        chown asterisk: "$dir"
                        chmod 750 "$dir"
                fi
        done


        ### this is done here in case asterisk-config was installed/upgraded first

        set +e # ignore errors temporarily
        chown -R asterisk:asterisk /etc/asterisk
        chmod -R 755 /etc/asterisk
        chown -R asterisk:asterisk /var/lib/asterisk
        chown -R asterisk:asterisk /var/log/asterisk
        chown -R asterisk:asterisk /var/spool/asterisk
        chown asterisk:asterisk /var/run/asterisk
        set -e
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

# Automatically added by dh_systemd_enable
# This will only remove masks created by d-s-h on package removal.
deb-systemd-helper unmask asterisk.service >/dev/null || true

# was-enabled defaults to true, so new installations run enable.
if deb-systemd-helper --quiet was-enabled asterisk.service; then
        # Enables the unit on first installation, creates new
        # symlinks on upgrades if the unit file has changed.
        deb-systemd-helper enable asterisk.service >/dev/null || true
else
        # Update the statefile to add new symlinks (if any), which need to be
        # cleaned up on purge. Also remove old symlinks.
        deb-systemd-helper update-state asterisk.service >/dev/null || true
fi
# End automatically added section

exit 0
